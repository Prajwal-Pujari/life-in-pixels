
// Get all users (admin only)
app.get('/api/admin/users', authenticateToken, isAdmin, async (req, res) => {
    try {
        const result = await pool.query(
            `SELECT id, username, email, full_name, role, employee_id, department, 
              is_active, created_at, last_login, avatar_url, google_id
       FROM users 
       ORDER BY created_at DESC`
        );

        const users = result.rows.map(user => ({
            id: user.id,
            username: user.username,
            email: user.email,
            fullName: user.full_name,
            role: user.role,
            employeeId: user.employee_id,
            department: user.department,
            isActive: user.is_active,
            createdAt: user.created_at,
            lastLogin: user.last_login,
            avatarUrl: user.avatar_url,
            authMethod: user.google_id ? 'google' : 'password'
        }));

        res.json(users);
    } catch (error) {
        console.error('❌ Error fetching users:', error);
        res.status(500).json({ error: 'Failed to fetch users' });
    }
});

// Create new user (admin only)
app.post('/api/admin/users', authenticateToken, isAdmin, async (req, res) => {
    try {
        const { username, password, email, fullName, role, employeeId, department } = req.body;

        // Validation
        if (!username || !password || !email || !fullName || !employeeId) {
            return res.status(400).json({
                error: 'Username, password, email, full name, and employee ID are required'
            });
        }

        if (password.length < 6) {
            return res.status(400).json({ error: 'Password must be at least 6 characters' });
        }

        // Check if username or email already exists
        const existingUser = await pool.query(
            'SELECT id FROM users WHERE username = $1 OR email = $2',
            [username, email]
        );

        if (existingUser.rows.length > 0) {
            return res.status(409).json({ error: 'Username or email already exists' });
        }

        // Hash password
        const passwordHash = await bcrypt.hash(password, 10);

        // Create user
        const result = await pool.query(
            `INSERT INTO users (
        username, password_hash, email, full_name, role, employee_id, department, is_active
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, true)
      RETURNING id, username, email, full_name, role, employee_id, department, is_active, created_at`,
            [username, passwordHash, email, fullName, role || 'employee', employeeId, department || null]
        );

        const newUser = result.rows[0];

        // Log activity
        await pool.query(
            'INSERT INTO activity_log (user_id, action_type, action_details) VALUES ($1, $2, $3)',
            [req.user.id, 'create_user', `Created user ${username} (${fullName})`]
        );

        console.log(`✅ Admin ${req.user.username} created new user: ${username}`);

        res.status(201).json({
            id: newUser.id,
            username: newUser.username,
            email: newUser.email,
            fullName: newUser.full_name,
            role: newUser.role,
            employeeId: newUser.employee_id,
            department: newUser.department,
            isActive: newUser.is_active,
            createdAt: newUser.created_at
        });
    } catch (error) {
        console.error('❌ Error creating user:', error);
        res.status(500).json({ error: 'Failed to create user' });
    }
});

// Deactivate user (admin only)
app.put('/api/admin/users/:id/deactivate', authenticateToken, isAdmin, async (req, res) => {
    try {
        const userId = req.params.id;

        // Prevent self-deactivation
        if (parseInt(userId) === req.user.id) {
            return res.status(400).json({ error: 'Cannot deactivate your own account' });
        }

        // Get user info before deactivating
        const userResult = await pool.query('SELECT username, full_name FROM users WHERE id = $1', [userId]);

        if (userResult.rows.length === 0) {
            return res.status(404).json({ error: 'User not found' });
        }

        const user = userResult.rows[0];

        // Deactivate user
        await pool.query('UPDATE users SET is_active = false WHERE id = $1', [userId]);

        // Log activity
        await pool.query(
            'INSERT INTO activity_log (user_id, action_type, action_details) VALUES ($1, $2, $3)',
            [req.user.id, 'deactivate_user', `Deactivated user ${user.username} (${user.full_name})`]
        );

        console.log(`⚠️ Admin ${req.user.username} deactivated user: ${user.username}`);

        res.json({ success: true, message: 'User deactivated successfully' });
    } catch (error) {
        console.error('❌ Error deactivating user:', error);
        res.status(500).json({ error: 'Failed to deactivate user' });
    }
});

// Reactivate user (admin only)
app.put('/api/admin/users/:id/activate', authenticateToken, isAdmin, async (req, res) => {
    try {
        const userId = req.params.id;

        const userResult = await pool.query('SELECT username, full_name FROM users WHERE id = $1', [userId]);

        if (userResult.rows.length === 0) {
            return res.status(404).json({ error: 'User not found' });
        }

        const user = userResult.rows[0];

        // Reactivate user
        await pool.query('UPDATE users SET is_active = true WHERE id = $1', [userId]);

        // Log activity
        await pool.query(
            'INSERT INTO activity_log (user_id, action_type, action_details) VALUES ($1, $2, $3)',
            [req.user.id, 'activate_user', `Reactivated user ${user.username} (${user.full_name})`]
        );

        console.log(`✅ Admin ${req.user.username} reactivated user: ${user.username}`);

        res.json({ success: true, message: 'User reactivated successfully' });
    } catch (error) {
        console.error('❌ Error reactivating user:', error);
        res.status(500).json({ error: 'Failed to reactivate user' });
    }
});
